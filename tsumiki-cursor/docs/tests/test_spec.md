# テスト仕様書（インシデント管理システム）

## プロジェクト情報
- **プロジェクト名**: インシデント管理システム
- **バージョン**: 1.0.0
- **作成日**: 2025-08-24
- **更新日**: 2025-08-24

## 1. テスト概要

### 1.1 テスト目的
要件・設計どおりに機能/非機能要件を満たすことを検証し、特に自動判定（緊急度/影響度）とSlackデータ取得の正確性・堅牢性を担保する。

### 1.2 テスト範囲
- 認証/認可、チャンネル管理、Slack取得（期間/スレッド/差分/レート制御）、
  ルール管理、自動判定、インシデント一覧/詳細、レポート/CSV、全文検索、監査ログ
- UIのWCAG2.2配慮、サーバーサイドAPIのみでの外部呼び出し

### 1.3 テスト方針
- TDD: 分類ロジック（urgency/impact/level）を先行してRed→Green→Refactor
- APIは統合テストで一連の保存/検索/更新を確認
- Slack APIはモックで再現（429/4xx/5xx）
- E2Eで主要ユーザーフローを確認

## 2. テストケース

### 機能テスト

#### TC-001: ログイン/ログアウト（認証・セッション）
- **目的**: シードユーザーのみがログイン可能で、セッションが保護ルートで検証される
- **前提条件**: シードユーザーが存在
- **テスト手順**:
  1. 正しいメール/パスワードでログイン
  2. 認証必須ページに遷移し表示成功
  3. ログアウトし、保護ページアクセスでログインへリダイレクト
- **期待結果**: 全手順成功、未認証時にAPIは401/リダイレクト
- **ステータス**: 

#### TC-010: チャンネル管理CRUD
- **目的**: /api/channelsで追加/更新/削除/一覧が動作
- **前提条件**: ログイン済
- **テスト手順**:
  1. 追加（有効=true）
  2. 一覧に表示、重複IDは弾かれる
  3. 有効/無効切替
  4. 削除
- **期待結果**: 正常系200、異常系に適切な4xx

#### TC-020: Slack取得（期間指定、スレッド、差分、重複排除）
- **目的**: 指定期間の投稿・スレッドを取得しraw JSONB保存、差分取得と重複排除が成立
- **前提条件**: Slack APIモック
- **テスト手順**:
  1. from/to指定でfetch実行
  2. replies取得を伴い保存
  3. 同範囲で再実行して新規のみ保存（差分）
- **期待結果**: 保存件数/履歴が正しい。複合一意(channel_id, slack_ts)で重複なし

#### TC-021: レート制限（429）バックオフ
- **目的**: 429時に指数バックオフし再試行、最終成功/失敗が履歴に残る
- **前提条件**: Slack APIモックが429を返す
- **テスト手順**: fetch実行→429→再試行
- **期待結果**: 一定回数で成功または失敗。履歴statusがrate_limited/failed/成功へ

#### TC-030: ルール管理CRUD（urgency/impact）
- **目的**: /api/rules でCRUD、正規表現の妥当性検証/無効化が効く
- **前提条件**: ログイン済
- **テスト手順**: 追加→一覧→更新（enabled切替/パターン修正）→削除
- **期待結果**: 不正なregexは400。enabled=falseは評価対象外

#### TC-040: 自動判定（緊急度）
- **目的**: キーワード/正規表現によりhigh/medium/lowを決定
- **前提条件**: urgency_rules定義
- **テスト手順**: 「緊急」「至急」「クリティカル」「停止」「障害」を含む投稿を評価
- **期待結果**: highに分類される

#### TC-041: 自動判定（影響度）
- **目的**: 文言から影響範囲を推定
- **前提条件**: impact_rules定義
- **テスト手順**: 「全ユーザー」「複数ユーザー」「特定ユーザー」を含む投稿を評価
- **期待結果**: high/medium/lowへ適切に分類

#### TC-042: インシデントレベル自動決定
- **目的**: 緊急度が中以上 or 影響度が高 → 障害、その他→不具合
- **前提条件**: TC-040/041が通過
- **テスト手順**: 組み合わせ表どおりに評価
- **期待結果**: レベルが仕様どおり

#### TC-050: 手動上書き（緊急度/影響度）
- **目的**: 自動判定後も手動で変更可、overridden=trueで記録
- **前提条件**: 既存インシデント
- **テスト手順**: PATCH /api/incidents/:id でurgency/impact更新
- **期待結果**: 値が更新され履歴/監査に記録、再分類で上書き保持

#### TC-060: インシデント一覧（検索/フィルタ/ページング）
- **目的**: 複合条件での絞り込み
- **前提条件**: 複数インシデントが存在
- **テスト手順**: q, 期間, urgency, impact, level, status の組み合わせで検索
- **期待結果**: 件数/内容が一致、ページング安定

#### TC-070: インシデント詳細（更新/履歴）
- **目的**: 詳細取得、担当者/メモ更新、変更履歴追跡
- **前提条件**: 既存データ
- **テスト手順**: GET→PATCH→GETで反映確認
- **期待結果**: 更新が保存・履歴参照可

#### TC-080: レポート/CSV
- **目的**: 要約/分布/期間推移の計算とCSVエクスポート
- **前提条件**: データあり
- **テスト手順**: summary取得、CSVダウンロード
- **期待結果**: 指標値が設計と一致、CSV列/エンコード(UTF-8)正しい

#### TC-090: 外部APIはサーバーサイドのみ
- **目的**: クライアントからSlackへ直接リクエストしない
- **前提条件**: E2Eでネットワーク監視
- **テスト手順**: UI操作時のネットワークログを確認
- **期待結果**: Slackドメインへのブラウザ発リクエストが存在しない

### 統合テスト

#### TI-001: 取得→分類→一覧→詳細の一連動作
- **目的**: 主要フローの整合性
- **手順**: fetch→保存→自動分類→一覧→詳細→上書き→再取得
- **期待結果**: すべての状態が整合

#### TI-002: ルール変更→新規投稿の分類反映
- **目的**: ルール変更後に新規データへ反映
- **手順**: ルール更新→新規fetch→分類確認
- **期待結果**: 新規に対して期待どおり分類

### 非機能テスト

#### パフォーマンス
- PF-001: ページロード90パーセンタイル3秒以内
- PF-002: 検索応答2秒以内（10万件）
- PF-003: 取得スループット1000メッセージ/分（モック）

#### セキュリティ
- SC-001: パスワードがbcryptでハッシュ化され平文保存なし
- SC-002: セッションCookieがHttpOnly/SameSite適切
- SC-003: CSRFトークン検証
- SC-004: SQLインジェクション対策（パラメータ化）
- SC-005: XSS対策（出力エスケープ）

#### アクセシビリティ（WCAG2.2 AA）
- AX-001: キーボードのみで主要操作が可能
- AX-002: フォーカスインジケータが可視
- AX-003: ラベル/aria関連付け適正

## 3. テストデータ

### 3.1 基本データセット
- 緊急度キーワード含む投稿例: 「緊急対応が必要」「至急確認」「クリティカル障害」「サービス停止」
- 影響度文言例: 「全ユーザー影響」「複数ユーザー」「特定ユーザーA」
- 通常投稿、英数字、リンク/コードブロック含むメッセージ

### 3.2 境界値データ
- 開始=終了の最小期間、深夜境界、うるう秒/日付境界
- 極端に長いメッセージ（上限-1, 上限, 上限+1）

### 3.3 異常系データ
- 無効な正規表現、巨大CSV、欠損フィールド

## 4. テスト環境

### 4.1 ハードウェア構成
- 開発者ローカル/CI共通で実行可能な標準構成

### 4.2 ソフトウェア構成
- Node.js 18+
- PostgreSQL (NeonテストDB)
- Next.js 14+

### 4.3 テストツール
- 単体/統合: Jest or Vitest
- E2E: Playwright
- モック: MSW/Nock

## 5. テスト実施計画

| フェーズ | 期間 | 担当者 | 備考 |
|---------|-----|-------|-----|
| 単体テスト |  |  | 分類/レベル/バリデーション優先 |
| 統合テスト |  |  | API/DB/Slackモック |
| システムテスト |  |  | E2E/アクセシビリティ |

## 6. 合格基準

- カバレッジ: 80%以上（ステートメント/ブランチ）
- バグ密度: 致命的0、重大0、軽微許容
- パフォーマンス基準: PF項目を全て満たす

## 7. リスクと対策
- Slack API仕様変更: 抽象化レイヤのモック更新で吸収
- モックと本番差異: ステージングで実データ小規模検証
